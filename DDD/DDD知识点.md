[TOC]



# 概念相关

### DDD的定义（是什么？解决什么问题？）

DDD是一套从领域或业务视角出发来指导系统设计的方法论，强调领域模型与业务的重要性。

主要是解决复杂软件设计中面临的问题。

**场景：**指导微服务的划分和设计；

DDD的战略设计强调边界，划分上下文，与微服务的划分基本一致；DDD的战术设计，强调领域建模，指导微服务的设计；



### 领域模型

某个特定业务领域的软件模型。它通过对象模型实现，内部同时包含了数据和行为，并且能表达出准确的业务含义和业务规则。

#### 领域模型是为了解决什么问题？

**贫血症**：现有的对象模型充斥着大量的get/set方法，这样的对象是没有行为的，也无法映射出实际的业务含义。这样就导致我们无法准确掌握（或者需要花很大代价）对象是如何被创建、使用和修改的，大量的逻辑分散在对象外部，导致对象本身并没有什么意义。同时对象数据或行为的约束也是分散在外部的，会造成测试和代码维护的困难。

举列子从对象的创建、使用、修改角度来说

具体例子为：

1. 对象创建：我们创建了一个采购单对象，我只是new了一个对象，但是这个对象在实际使用中会有各种约束，比如一些必填字段的限制，这些我在创建对象的时候并没有限制，这就导致了对象在使用过程中需要做各种的防御，业务规则也泄露到外部调用端



领域模型就是为了解决软件开发过程中贫血模型造成的失忆症，让对象丰富起来，不仅包括数据还包括业务行为。让对象的行为约束都封闭到对象内部来实现，防止了逻辑的外泄。



### 领域划分

**核心域**：一个业务的核心，决定了业务的成败

**支撑子域**：非核心的业务功能，对核心域的起到支撑作用

**通用子域**：被所有业务系统使用的子域，比如权限、认证等

举例：

采购域的划分：采购系统（核心域），计划系统（支撑子域），订单中心（支撑子域），权限（通用子域）



### 通用语言

**定义：**能准确表达业务涵义与规则的语言。

**作用或价值：**

1. 统一团队内部的沟通术语，减少沟通的成本，防止出现理解偏差
2. 指导领域建模（领域模型是需要反映特定业务涵义）；通用语言的名词可以给领域对象命名，通用语言中的动词可以表示为命令或领域事件

**创建通用语言的方式**：事件风暴



### 限界上下文

**定义**：是一个语义上的边界，为了保证通用语言的准确性，没有二义性，同时也保证了领域模型的确定性。因为领域模型是对通用语言的软件建模

**特点：**

1. 限界上下文是子域的一部分
2. 限界上下文的边界特性，保证了一个限界上下文内部通用语言的唯一性
3. 一个限界上下文一般对应一个微服务

**限界上下文如何划分：**





### 实体

**定义：**具有唯一标识，并会持续变化的一种对象；实体是通用语言对应的软件模型，有丰富的业务含义

**特点：**

1. 具有唯一性
2. 会持续的变化（一般会存在生命周期）
3. 能表达特定的业务含义和规则

**实体的创建、属性的验证：**通过**自封装性**进行验证，即无论以哪种方式进行数据访问，都必须通过getter/setter方法

**整体对象的验证、对象组合的验证：**对象加载完成后，延迟验证，通过领域服务进行验证





### 值对象

**定义：**对于领域中某个事物的度量或描述，而不是某个领域中的一个特定东西。比如，年龄并不是一个实在的事物，而是对出生年份的一个度量；

**特点：**

1. 不变性：值对象创建后就不可以再修改
2. 相等性：两个值对象如果属性相同，则两个对象相等
3. 可替换性：如果一个值对象发生改变，则需要重新构建一个新对象来替换

**特殊场景：**

1. 值对象对实体对象引用：尽量避免该场景，可以通过实体对象创建一个值对象来给值对象进行使用；或者使用领域服务
2. 是否所有属性都应该创建一个值对象：对于布尔类型，数值类型等与其它属性没有关联，并且可以完整表示自身含义的属性，被称为**意义整体**。这些简单属性是不需要创建为一个值对象的。



### 领域服务

**定义：**是一种无状态操作，用于实现特定于某个领域的任务，具有充足的业务逻辑或行为；

**什么场景下使用：**实体、聚合和值对象不适合时，才使用领域服务。所以领域服务不是必须的

1. 某个业务逻辑需要操作多个实体
2. 对领域对象进行转换

例如：

1. 实体对象的整体校验（延迟校验），比如实体对象的多个属性之间关系的校验（会导致整个实体是否可用）；通过double dispatch的方式，将领域服务当做入参传递到实体方法中
2. 实体对象组合的校验
3. 对实体对象来说较为复杂的逻辑





### 领域事件

**定义**：领域内发生的事件，该事件会引发其它的业务操作

**收益：**将当前的业务行为与接下来的业务行为进行解耦（采用异步化解耦）

#### **使用**

**事件构建与发布**

事件结构：Id（全局唯一）、发生时间、事件源、事件类型

发布：1. 事件持久化之后通过轮询来发布  2. 通过监听数据库binlog来发布

**事件实体持久化**

1. 事件实体与业务实体同一个数据源，保证事务；（消息组件将领域事件写入数据库）
2. 事件实体与业务实体数据源分开，通过XA事务保证一致性；（RocketMQ的事务消息）
3. 事件实体与业务实体同一个数据源，限界上下文对消息进行持久化，保证事务；

**柔性事务（发布方与订阅方的一致性）**

1. 订阅方处理消息需要支持**幂等**（通过防重实现）、能处理消息时序问题；
2. 发布方与订阅方需要有一致性的校验；



### 聚合

**定义：**多个实体或值对象的组合。聚合主要是为了表示一个内聚的业务概念或行为

**特点：**

1. 聚合根本身就是一个实体，需要有唯一的标识
2. 所有对聚合内部实体的引用都需要通过聚合去操作，外部不能直接操作聚合内部的实体
3. 一个事务中只能修改一个聚合实例
4. 聚合根可以引用其它聚合根，但是不能直接引用对象，而是通过唯一标识进行引用；这样就保证了在当前聚合根内不会对其它聚合根进行修改，也就遵循了上述的单个事务只修改一个聚合实例
5. 不同聚合根之间采用最终一致性保证事务（领域事件解耦）



### 六边形架构 + CQRS

**DDD分层架构**: 用户接口层、应用层、领域层、基础层

**整洁架构：**


